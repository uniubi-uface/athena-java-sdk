<div style="text-align: center; font-size: 36px; font-weight: bold">UStar Cloud SDK Interface Document</div>

<br/><br/>

# 0 Revision Records

> The interface document version corresponds to the version number of UStarCloud

| SDK Version | Revision Time | Revised by | Content                                              |
| ------- | -------- | ------ | ------------------------------------------------------------ |
| 2.3.0 | 11/22/2021 | jingmu | 1. new file |
| 2.3.0 | 06/08/2022 | jingmu | 1. update `5 Event Subscription Callback` |

<br/><br/>

# 1 Request Explanation

## 1.1 Request Address

**Unified path: `https://www.ustar-cloud.com/api/develop/sdk/unify`**

* Request method：`POST`
* Request header：`Content-Type: application/json;charset=UTF-8`

| Field Name            | Location   | Type   | Required | Description                                                         |
| ------------------- | ------ | ------ | -------- | ------------------------------------------------------------ |
| sdkRequestKey     | header | String | Y        | Request KEY                                                  |
| requestKeyVersion | header | String | Y        | the version of Request KEY,default `v1`                                  |
| sdkAccessToken    | header | String | Y        | Token obtained from the Server                               |
| sdkSecretKey      | header | String | Y        | AES KEY ciphertext encrypted by [RSA publicKe](#2)           |
| lang                | header | String | Y        | Language types, please refer to [Dictionary 3.1](#3.1) for details |
| requestData         | body   | String | Y        | requestData is either encrypted or unencrypted, as described in the [requestData Explanation](#requestData) |

* `sdkAccessToken`: The validity period is 1 day and can be retrieved after expiration

* `AES KEY`: AES KEY is generated by the developer itself and each request suggests a different KEY，the rule in the [AES](#2.2)
* java AES Example:

```java

    public static String generateAesKey() {
        try {
            KeyGenerator keyGenerator = KeyGenerator.getInstance("AES");
            keyGenerator.init(128);
            SecretKey sk = keyGenerator.generateKey();
            byte[] b = sk.getEncoded();
            return byteToHexString(b);
        }
        catch (NoSuchAlgorithmException e) {
            return null;
        }
    }

    private static String getAesIv(String aesKey) {
            String reverseKey = new StringBuilder(aesKey).reverse().toString();
            return reverseKey.substring(0, 16);
    }

    public static String encryptByAes(String key, String content) {
            String result = "";
            try {
            Cipher cipher;
            cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
            byte[] raw = key.getBytes();
            SecretKeySpec skeySpec = new SecretKeySpec(raw, "AES");
            IvParameterSpec iv = new IvParameterSpec(getAesIv(key).getBytes());
            cipher.init(Cipher.ENCRYPT_MODE, skeySpec, iv);
            byte[] encrypted = cipher.doFinal(content.getBytes(StandardCharsets.UTF_8));
            result = new BASE64Encoder().encode(encrypted);
            }
            catch (Exception e) {
            return result;
            }
            return result;
    }
```
## 1.2 requestData Explanation<a id="requestData"></a>

### 1.2.1 Encrypted Interface

The parameter to the interface is the value of the json object requestData, namely

```json
   {
      "requestData": {
      "pageSize": 10,
      "empNo": "58693",
      "pageNum": 1
      }
   }
```

The above json string is then encrypted with AES as the request body

 ```
 PK0AgL+Ws/TCzw2/PPzPhJnCgXqwb0ZddQ4o+EDGDhXhibTj2KXEqF2CXRKZ8OOgqZuktd1uvEHA
 0VBz9I8iZw==
 ```

Example of request body in Postman
![Postman body img1](./img/image1.png)

### 1.2.2 Unencrypted Interface

Unencrypted Interface: directly take the interface parameter as the value of the JSON object requestData

```json
  {
    "requestData": {
      "accessKey": "1dc8908e728b445d91c4d133ef40c92a",
      "accessSecret": "09555323806d4e809eee1617082ea6b1"
    }
  }
```
The above json string serves as a request body

Example of request body in Postman

![Postman body img2](./img/image2.png)

# 2 Secret Key<a id="2"></a>

> The Manager creates a new developer platform on the UStarCloud developer access platform page
>
> The system will automatically generate `accessKey ` and `accessSecret`for the new platform, as well as `publicKey`
>
> `accessKey` and `accessSecret` are used for permission authentication to generate `sdkAccessToken`

## 2.1 RSA

The RSA `public key` and `private key` are generated by `UStar`, and then the RSA `public key` is obtained from the docking platform page of `UStar`. The `public key` is used to encrypt and decrypt `AES keys`

## 2.2 AES<a id="2.2"></a>

* AES keys are generated by the developers themselves and use `128 bits`
* The offset `iv` is obtained from the `AES key`. The rule is: in the first step, reverse the `AES key` and  take the first 16 characters

# 3 Data Dictionary

> Each dictionary data includes but not limited to the following dictionary items

## 3.1 Language<a id ="3.1"></a>

| Dictionary Item | Dictionary Value | Value Type | Explanation        |
| --------------- | ---------------- | ---------- | ------------------ |
| Chinese         | zh_CN            | String     | Simplified Chinese |
| English         | en               | String     | English            |

## 3.2 Gender<a id ="3.2"></a>

| Dictionary Item | Dictionary Value | Value Type | Explanation   |
| --------------- | ---------------- | ---------- | ------------- |
| Not filled in   | 0                | number     | not filled in |
| Male            | 1                | number     | Male          |
| Female          | 2                | number     | Female        |

## 3.3 Employee Permission Type<a id="3.3"></a>

| Dictionary Item      | Dictionary Value | Value Type | Explanation          |
| -------------------- | ---------------- | ---------- | -------------------- |
| Face Recognition     | 1                | number     | Face Recognition     |
| Card Recognition     | 2                | number     | Card Recognition     |
| Face-card-in-one     | 3                | number     | Face-card-in-one     |
| Face-card comparison | 4                | number     | Face-card comparison |

## 3.4 Event Type<a id="3.4"></a>

| Dictionary Item          | Dictionary Value | Value Type | Explanation              |
| ------------------------ | ---------------- | ---------- | ------------------------ |
| Recognition record event | 1                | number     | Recognition record event |
| Employee add event       | 2                | number     | Employee add event       |
| Employee update event    | 3                | number     | Employee update event    |
| Employee delete event    | 4                | number     | Employee delete event    |
| Department add event     | 5                | number     | Department add event     |
| Department update event  | 6                | number     | Department update event  |
| Department delete event  | 7                | number     | Department delete event  |

> Attention：Currently only supports Recognition record event

## 3.5 Attendance Date Type<a id="3.5"></a>

| Dictionary Item                  | Dictionary Value | Value Type | Explanation                      |
| -------------------------------- | ---------------- | ---------- | -------------------------------- |
| Working day (normal timetable)   | 1                | number     | Working day (normal timetable)   |
| Working day (flexible timetable) | 2                | number     | Working day (flexible timetable) |
| Weekend                          | 3                | number     | Weekend                          |
| Holiday                          | 4                | number     | Holiday                          |
| Not scheduled                    | 5                | number     | Not scheduled                    |

## 3.6 Device Status<a id="3.6"></a>

| Dictionary Item       | Dictionary Value | Value Type | Explanation           |
| --------------------- | ---------------- | ---------- | --------------------- |
| Device offline        | 0                | number     | Device offline        |
| Device Online         | 1                | number     | Device Online         |
| Device disabled       | 2                | number     | Device disabled       |
| Device password error | 3                | number     | Device password error |

# 4 SDK Interface

## 4.1 Interface Response Explanation

> In ResponseHeader: `Content-Type: application/json;charset=UTF-8`

### 4.1.1 Unified Result Return Field<a id="4.1.1"></a>

| Field Name | Field Type | Explanation                                                  |
| :--------- | :--------- | :----------------------------------------------------------- |
| code       | String     | Return the code of the parameter, `1000_sus` indicates success, others indicate failure. |
| success    | boolean    | `true` indicates success, and `false` indicates failure      |
| msg        | String     | `successful operation!`  or `operation failed!`              |
| data       | Object     | AES encrypted string of the data returned by each request    |
| secret     | String     | The AES KEY ciphertext encrypted by RSA private key (decryption with public key is required) |

**Note：**

* **If the interface in 4.2 does not return data, the data field of the actual interface is `None`.**
* **If the field name of the interface in 4.2 is None, the returned data is the content of the data field.**

### 4.1.2 Result Return Field in Paging

> The following fields are the data of the Data Field in the public response field.

| Field Name | Field Type      | Explanation                                                  |
| ---------- | --------------- | ------------------------------------------------------------ |
| pageNum    | number(integer) | Page number                                                  |
| pageSize   | number(integer) | Number of paging data                                        |
| pages      | number(integer) | Total page number                                            |
| total      | number(long)    | Total data number                                            |
| list       | array(list)     | Data array java list The data of paging query interface is actually the content of the list. |

## 4.2 Test Interface

### 4.2.1 Test Interface

* sdkRequestKey : `test`

* Request parameter explanation：no request parameter

* Response parameter explanation：

  | Field Name | Field Type | Explanation                               |
  | ---------- | ---------- | ----------------------------------------- |
  | None       | String     | Hello, this is the offline client service |

## 4.3 Authentication API

### 4.3.1 Obtain sdkAccessToken

* sdkRequestKey : `authToken`

* Request parameter explanation

  | Field Name   | Field Type | Required | Explanation                                       |
  | ------------ | ---------- | -------- | ------------------------------------------------- |
  | accessKey    | String     | Y        | Developer accesses to the platform page to obtain |
  | accessSecret | String     | Y        | Developer accesses to the platform page to obtain |

  > the request need not secreted
   ```json
   {
       "requestData":{
           "accessKey":"1dc8908e728b445dxxxxxxxxx",
           "accessSecret":"09555323806d4exxxxxxxxxxxxxx"
       }
   }
   ```
* Response parameter explanation

  | Field Name | Field Type | Explanation                                                  |
  | ---------- | ---------- | ------------------------------------------------------------ |
  | None       | String     | The returned string is the credential that requests other interface and is placed in the request header `SDK _ACCESS_TOKEN` |

  > **Note: token is not encrypted and is valid for 1 day.**

## 4.4 Attendance Report API

### 4.4.1 Attendance Details Report

* sdkRequestKey : `atdDetailReport`

* Request parameter explanation

  | Field Name | Field Type | Required | Explanation                    |
  | ---------- | ---------- | -------- | ------------------------------ |
  | pageNum    | Integer    | Y        | Page number                    |
  | pageSize   | Integer    | Y        | Limit number of items per page |
  | deptId     | String     | N        | Department ID                  |
  | empName    | String     | N        | Department Name/Number         |
  | startDate  | date       | N        | Start date: yyyy-MM-dd         |
  | endDate    | date       | N        | End date: yyyy-MM-dd           |

* Response parameter explanation

  | Field Name             | Field Type   | Explanation                                                  |
  | ---------------------- | ------------ | ------------------------------------------------------------ |
  | personId               | String       | Personnel ID                                                 |
  | personNo               | String       | Employee No                                                  |
  | name                   | String       | Employee Name                                                |
  | depNames               | String array | Department Name Array                                        |
  | roleNames              | String array | Position Name Array                                          |
  | atDate                 | date         | Date: yyyy-MM-dd                                             |
  | timeIntervalName       | String       | Timetable Name                                               |
  | planSignInDatetime     | Date         | Planned clock-in time: yyyy-MM-dd HH:mm:ss                   |
  | planSignOutDatetime    | Date         | Planned clock-out time: yyyy-MM-dd HH:mm:ss                  |
  | planTimeIntervalSecond | long number  | Planned working time period, in seconds                      |
  | realSignInTime         | Date         | Actual clock-in time: yyyy-MM-dd HH:mm:ss                    |
  | signInStatus           | number       | Clock-in status: 1. Normal; <br />2. Not clocked-in; <br />3. Late;<br />4. Early;<br />5. Not clock-in yet; <br />6. Overtime |
  | realSignOutTime        | date         | Actual clock-out time: yyyy-MM-dd HH:mm:ss                   |
  | signOutStatus          | number       | Clock-in status: 1. Normal; <br />2. Not clocked-in; <br />3. Late;<br />4. Early;<br />5. Not clock-in yet; <br />6. Overtime |
  | realWorkTimeSecond     | long number  | Actual working time, in seconds                              |
  | normalWorkSecond       | long number  | Normal working time, in second                               |
  | realLateSecond         | long number  | Late time, in seconds                                        |
  | realLeaveEarlySecond   | long number  | Early time, in seconds                                       |
  | realAbsenteeismSecond  | long number  | Absence Time, in seconds                                     |
  | workDayOverWorkSecond  | long number  | Workday Overtime, in seconds                                 |
  | restDayOverWorkSecond  | long number  | Weekend Overtime, in seconds                                 |
  | holidayOverWorkSecond  | long number  | Holiday Overtime, in seconds                                 |
  | dateType               | number       | Date type, Dictionary data [3.5](#3.5)                       |
  | signInStart            | Date         | Start clock-in time, which has a value if and only if dateType=2 |
  | signInEnd              | Date         | End clock-in time, which has a value if and only if dateType=2 |

### 4.4.2 Time Attendance Report

* sdkRequestKey : `atdOverWorkReport`

* Request parameter explanation

  | Field Name | Field Type | Required | Explanation                    |
  | ---------- | ---------- | -------- | ------------------------------ |
  | pageNum    | Integer    | Y        | Page Number                    |
  | pageSize   | Integer    | Y        | Limit number of items per page |
  | deptId     | String     | N        | Department ID                  |
  | empName    | String     | N        | Department Name/Number         |
  | startDate  | date       | N        | Start Date: yyyy-MM-dd开       |
  | endDate    | date       | N        | End Date: yyyy-MM-dd           |

* Response parameter explanation

  | Field Name            | Field Type   | Explanation                                     |
  | --------------------- | ------------ | ----------------------------------------------- |
  | personId              | String       | Employee ID                                     |
  | personNo              | String       | Employee No                                     |
  | name                  | String       | Employee Name                                   |
  | depNames              | String array | Department Name Array                           |
  | roleNames             | String array | Position Name Array                             |
  | atDate                | date         | Date: yyyy-MM-dd                                |
  | workDayOverWorkSecond | long number  | Workday Overtime, in seconds                    |
  | restDayOverWorkSecond | long number  | Weekend Overtime, in seconds                    |
  | holidayOverWorkSecond | long number  | Holiday Overtime, in seconds                    |
  | dateType              | number       | Date type, refer to Dictionary Data [3.5](#3.5) |

### 4.4.3 Attendance Rest Report

* sdkRequestKey : `atdBreakTimeReport`

* Request parameter explanation

  | Field Name | Field Type | Required | Explanation                    |
  | ---------- | ---------- | -------- | ------------------------------ |
  | pageNum    | Integer    | Y        | Page Number                    |
  | pageSize   | Integer    | Y        | Limit number of items per page |
  | deptId     | String     | N        | Department ID                  |
  | empName    | String     | N        | Department Name/No             |
  | startDate  | date       | N        | Start Date: yyyy-MM-dd         |
  | endDate    | date       | N        | End Date: yyyy-MM-dd           |

* Response parameter explanation

  | Field Name            | Field Type   | Explanation                                         |
  | --------------------- | ------------ | --------------------------------------------------- |
  | personId              | String       | Employee ID                                         |
  | personNo              | String       | Employee No                                         |
  | name                  | String       | Employee Name                                       |
  | depNames              | String array | Department Name Array                               |
  | roleNames             | String array | Position Name Array                                 |
  | atDate                | date         | Date: yyyy-MM-dd                                    |
  | timeIntervalName      | String       | Timetable Name                                      |
  | breatimeName          | String       | Rest Timetable Name                                 |
  | planBreakTimeDuration | long number  | Planned Rest Time, in seconds                       |
  | realBreakTimeStart    | Date         | Actual Rest Start Time: yyyy-MM-dd                  |
  | realBreakTimeEnd      | Date         | Actual Rest End Time: yyyy-MM-dd                    |
  | realBreakTimeDuration | long number  | Actual rest time, in seconds                        |
  | breakStatus           | number       | Rest Status：0-Not calculated，1-Normal，2-Abnormal |

### 4.4.4 Abnormal Clock-in Report

* sdkRequestKey : `atdExceptionReport`

* Request parameter explanation

  | Field Name | Field Type | Required | Explanation                    |
  | ---------- | ---------- | -------- | ------------------------------ |
  | pageNum    | Integer    | Y        | Page Number                    |
  | pageSize   | Integer    | Y        | Limit number of items per page |
  | deptId     | String     | N        | Department ID                  |
  | empName    | String     | N        | Department Name/Number         |
  | startDate  | date       | N        | Start Date: yyyy-MM-dd         |
  | endDate    | date       | N        | End Date: yyyy-MM-dd           |

* Response parameter explanation

  | Field Name      | Field Type   | Explanation                        |
  | --------------- | ------------ | ---------------------------------- |
  | personId        | String       | Employee ID                        |
  | personNo        | String       | Employee No                        |
  | name            | String       | Employee Name                      |
  | depNames        | String array | Department Name Array              |
  | roleNames       | String array | Position Name Array                |
  | atDate          | date         | Date: yyyy-MM-dd                   |
  | recognitionTime | Date         | Clock-in time: yyyy-MM-dd HH:mm:ss |
  | clockPhotoId    | String       | Clock photo ID                     |
  | deviceKey       | String       | Device Key                         |
  | deviceName      | String       | Device name                        |

# 5 Event Subscription Callback

> The Manager logs in to the Ustar client and sets the callback address and mattered events of the docking platform on the developer docking platform page.
>
> The Ustar client system monitors these events internally and sends the information of these events as they occur to the docking platform that has followed them.
>
> If the message sending fails due to network reasons, the system will retry the sending, and the maximum number of retries is 20, with an interval of 5 minutes each time.

Ustar cloud will send an HTTP request to the address configured by each development platform. The request method is post. Content-Type is application/json.

## 5.1 Event Message Structure Explanation

* Request Method：`POST`

* Request Header ：`Content-Type: application/json`

* Request Body：

  | Field Name | Field Type   | Explanation                                                  |
  | ---------- | ------------ | ------------------------------------------------------------ |
  | msgId      | String       | Message id                                                   |
  | type       | number(byte) | java byte typeMessage type, refer to the data dictionary for detailsjava byte [3.4](#3.4) |
  | content    | String       | The message content is json string of the event callback content |

* Response body content:

  | ~~Field Name~~ | ~~Field Type~~ | ~~Explanation~~                                              |
  | -------------- | -------------- | ------------------------------------------------------------ |
  | ~~success~~    | ~~boolean~~    | ~~Whether received successfully<br />If `true` is returned, the system will no longer process the message<br />If `false` is returned, the system will retry after 5 minutes~~ |

> ~~**Note 1：The response data is required to be returned in JSON format**~~
>
> ~~**Note 2: When processing a system callback message, the message is processed successfully only if it returns a successful return result correctly, otherwise the system will keep retrying.**~~
>
> ~~**Note 3: The consumer needs to do idempotence control.**~~
>
> ~~**Note 4: Event Message Push sends the data as HTTP, the request does not contain permissions and authentication information.**~~

**To facilitate docking, ustarcloud will decide whether to resend according to whether the HTTP status code returned by the request for pushing data is 200**

> HTTP status code = 200 indicates that the development platform has successfully processed the pushed message, and ustarcloud will not retry.
>
> HTTP status code !=  200 indicates that the development platform failed to process the pushed message, and ustarcloud will continue to retry.
>
> So, boys, if you fail to process the pushed message, please do not set the HTTP status code to 200

## 5.2 Callback Event

### 5.2.1 Recognition Record Callback Event

* Trigger condition: when the device recognition record is called back to the system

* Event callback content:

  | Field Name         | Field Type   | Explanation                                                  |
  | ------------------ | ------------ | ------------------------------------------------------------ |
  | id                 | number       | Recognition record id                                        |
  | orgId              | number       | Company id                                                   |
  | personType         | number       | record person type<br />1:employee;<br />2:visitor;<br />3:stranger |
  | deviceKey          | String       | Device SN                                                    |
  | deviceName         | String       | Device Name                                                  |
  | personId           | Long         | Person ID or Visitor ID                                      |
  | empNo              | String       | employee                                                     |
  | departmentNames    | string array | Department names (only for employee)                         |
  | name               | String       | Person Name                                                  |
  | showTime           | Date         | recognition time，format：yyyy-MM-dd HH:mm:ss                |
  | temperatureUnit    | number       | temperature Unit<br />1：Celsius  <br />2：Fahrenheit        |
  | temperatureState   | number       | Body temperature status <br />1：Normal<br />2：Abnormal<br />3：Not set<br />4：Body temperature not measured<br />null: Body temperature not measured |
  | aliveBody          | number       | Live detection <br />1：Live<br />2：Non-live<br />3：Not detected |
  | permissionTimeType | number       | Permission time judgment <br />1:Within the permission time<br />2:Not within the permission time<br />3:Not set |
  | passTimeType       | number       | Permission date judgment <br />1:Within the permission date<br />2:Not within the permission date<br />3:Not set |
  | recMode            | number       | recognition mode<br />1:face,<br />2:card,<br />3:face&card  |
  | type               | number       | Recognition <br />1:successful;<br />2:failed                |
  | photoUrl           | String       | Scene Photo URL                                              |

* request body example:

```json
{
    "msgId": "this is msgId",
    "type": 1,
    "content": "{\"aliveType\":1,\"depNameConcat\":\"name1,name2\",\"departmentNames\":[\"name1\",\"name2\"],\"deviceKey\":\"84E0F42C3BB78702\",\"deviceName\":\"this is device name\",\"empNo\":\"001\",\"id\":3126713,\"name\":\"Joey T\",\"orgId\":97,\"passTimeType\":1,\"permissionTimeType\":1,\"personGuid\":null,\"personId\":8508,\"personType\":1,\"photoUrl\":\"https://uniubi-aiot.s3-eu-west-1.amazonaws.com/pkg365/2005/20050001000506/034000.411/img/ffe1fd7d-eecc-45c3-a6cf-14cee5c3361a.station\",\"recMode\":1,\"recStatus\":null,\"recType\":1,\"showTime\":\"2022-05-20 03:39:59\",\"temperature\":null,\"temperatureState\":null,\"temperatureUnit\":null,\"type\":1}"
}
```

